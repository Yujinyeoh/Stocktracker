<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Stock Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Info Modal Component
    const InfoModal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
            <div className="sticky top-0 bg-gray-700 px-6 py-4 flex justify-between items-center border-b border-gray-600">
              <h3 className="text-xl font-bold">{title}</h3>
              <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div className="p-6 text-sm">
              {children}
            </div>
          </div>
        </div>
      );
    };

    // RSI Info Content
    const RSIInfoContent = () => (
      <div className="space-y-4">
        <div>
          <h4 className="font-bold text-lg mb-2">What is RSI?</h4>
          <p className="text-gray-300">
            RSI (Relative Strength Index) measures momentum by comparing recent gains to losses over the last 14 days. It's a number between 0-100.
          </p>
        </div>

        <div className="bg-gray-700 p-4 rounded-lg">
          <h4 className="font-bold mb-3">Understanding RSI Zones:</h4>
          
          <div className="space-y-3">
            <div className="flex items-start gap-3">
              <span className="text-green-400 font-bold text-xl">üü¢</span>
              <div>
                <p className="font-semibold text-green-400">RSI &lt; 30: Oversold</p>
                <p className="text-gray-300 text-xs mt-1">Stock has been falling rapidly. May be undervalued and could bounce back soon. Potential buying opportunity.</p>
              </div>
            </div>

            <div className="flex items-start gap-3">
              <span className="text-blue-400 font-bold text-xl">üîµ</span>
              <div>
                <p className="font-semibold text-blue-400">RSI 30-70: Neutral</p>
                <p className="text-gray-300 text-xs mt-1">Balanced momentum. Normal trading range with no extreme conditions. Most stocks fall in this range.</p>
              </div>
            </div>

            <div className="flex items-start gap-3">
              <span className="text-red-400 font-bold text-xl">üî¥</span>
              <div>
                <p className="font-semibold text-red-400">RSI &gt; 70: Overbought</p>
                <p className="text-gray-300 text-xs mt-1">Stock has been rising rapidly. May be overvalued and could pull back soon. Consider taking profits.</p>
              </div>
            </div>
          </div>
        </div>

        <div>
          <h4 className="font-bold mb-2">Example:</h4>
          <div className="bg-gray-900 p-3 rounded text-xs space-y-2">
            <p><span className="text-yellow-400">TSLA RSI = 25</span> ‚Üí Stock dropped from $240 to $220 over 2 weeks. Heavy selling pressure. May recover soon. üü¢</p>
            <p><span className="text-yellow-400">NVDA RSI = 80</span> ‚Üí Stock rose from $450 to $490 over 2 weeks. Strong buying pressure. May cool off soon. üî¥</p>
          </div>
        </div>

        <div className="bg-yellow-900 bg-opacity-30 border border-yellow-700 p-3 rounded">
          <p className="text-yellow-200 text-xs">
            ‚ö†Ô∏è <strong>Note:</strong> RSI is just one indicator. Always combine it with other analysis and research before making investment decisions.
          </p>
        </div>
      </div>
    );

    // Tech Score Info Content
    const TechScoreInfoContent = () => (
      <div className="space-y-4">
        <div>
          <h4 className="font-bold text-lg mb-2">What is the Tech Score?</h4>
          <p className="text-gray-300">
            Our Technical Score (0-100) combines 5 key indicators to give you a quick assessment of a stock's technical strength. Higher scores indicate more bullish signals.
          </p>
        </div>

        <div className="bg-gray-700 p-4 rounded-lg">
          <h4 className="font-bold mb-3">Score Breakdown (Total: 100 points):</h4>
          
          <div className="space-y-3">
            <div>
              <p className="font-semibold text-blue-400">1Ô∏è‚É£ RSI Score (0-30 points)</p>
              <p className="text-gray-300 text-xs mt-1">
                Best: 50-70 range = 30pts | Oversold/Overbought = 10-20pts | Extreme zones = 0-10pts
              </p>
            </div>

            <div>
              <p className="font-semibold text-blue-400">2Ô∏è‚É£ Price Momentum (0-25 points)</p>
              <p className="text-gray-300 text-xs mt-1">
                Based on today's price change: +3% or more = 25pts | +1% to +3% = 20pts | Negative = 5-10pts
              </p>
            </div>

            <div>
              <p className="font-semibold text-blue-400">3Ô∏è‚É£ Moving Average Trend (0-20 points)</p>
              <p className="text-gray-300 text-xs mt-1">
                "Golden Cross" (Price &gt; 20-day avg &gt; 50-day avg) = 20pts | Price above both = 15pts
              </p>
            </div>

            <div>
              <p className="font-semibold text-blue-400">4Ô∏è‚É£ Volatility (0-15 points)</p>
              <p className="text-gray-300 text-xs mt-1">
                High volatility (3-8%) = 15pts | Moderate (1-3%) = 10pts | Shows trading activity and opportunities
              </p>
            </div>

            <div>
              <p className="font-semibold text-blue-400">5Ô∏è‚É£ Market Cap Stability (0-10 points)</p>
              <p className="text-gray-300 text-xs mt-1">
                Large cap (&gt;$200B) = 10pts | Mid cap (&gt;$10B) = 8pts | Rewards stability
              </p>
            </div>
          </div>
        </div>

        <div className="bg-gray-700 p-4 rounded-lg">
          <h4 className="font-bold mb-3">What the Scores Mean:</h4>
          <div className="space-y-2 text-xs">
            <p><span className="bg-green-600 px-2 py-1 rounded font-semibold">85-100</span> <span className="text-green-400">Strong Buy</span> - Almost all signals are positive</p>
            <p><span className="bg-green-700 px-2 py-1 rounded font-semibold">75-84</span> <span className="text-green-400">Buy (4)</span> - Most signals look good</p>
            <p><span className="bg-green-800 px-2 py-1 rounded font-semibold">65-74</span> <span className="text-green-300">Buy (3)</span> - Some positive signals</p>
            <p><span className="bg-yellow-700 px-2 py-1 rounded font-semibold">55-64</span> <span className="text-yellow-400">Buy (2)</span> - Cautiously optimistic</p>
            <p><span className="bg-yellow-600 px-2 py-1 rounded font-semibold">45-54</span> <span className="text-yellow-300">Hold</span> - Neutral, wait and see</p>
            <p><span className="bg-red-600 px-2 py-1 rounded font-semibold">0-44</span> <span className="text-red-400">Sell</span> - Bearish signals</p>
          </div>
        </div>

        <div>
          <h4 className="font-bold mb-2">Example Calculation:</h4>
          <div className="bg-gray-900 p-3 rounded text-xs space-y-1">
            <p className="text-yellow-400 font-semibold">AAPL with 90/100 Score:</p>
            <p>‚Ä¢ RSI = 65 (sweet spot) ‚Üí 30 pts ‚úÖ</p>
            <p>‚Ä¢ Daily change = +1.5% ‚Üí 20 pts ‚úÖ</p>
            <p>‚Ä¢ Golden Cross pattern ‚Üí 20 pts ‚úÖ</p>
            <p>‚Ä¢ Volatility = 1.7% ‚Üí 10 pts ‚úÖ</p>
            <p>‚Ä¢ $2.8T market cap ‚Üí 10 pts ‚úÖ</p>
            <p className="text-green-400 font-semibold mt-2">Total: 90 = STRONG BUY üöÄ</p>
          </div>
        </div>

        <div className="bg-red-900 bg-opacity-30 border border-red-700 p-3 rounded">
          <p className="text-red-200 text-xs">
            <strong>‚ö†Ô∏è Important Limitations:</strong> This system ONLY looks at price patterns and technical indicators. It does NOT consider:
          </p>
          <ul className="text-red-200 text-xs mt-2 space-y-1 ml-4 list-disc">
            <li>Company earnings, revenue, or profitability</li>
            <li>News events, product launches, or scandals</li>
            <li>Economic factors (interest rates, recession risks)</li>
            <li>Industry trends or competitive threats</li>
          </ul>
          <p className="text-red-200 text-xs mt-2 font-semibold">
            Always do your own research! Use this as a starting point, not your only decision tool.
          </p>
        </div>
      </div>
    );
    
    // API Configuration - ALL keys now securely stored in Vercel environment variables!
    // No API keys exposed in frontend code = secure! üîí
    
    // üìä Full stock watchlist with exchange info for Google Finance links
    const WATCHLIST = [
      { symbol: 'AAPL', exchange: 'NASDAQ' },
      { symbol: 'MSFT', exchange: 'NASDAQ' },
      { symbol: 'GOOGL', exchange: 'NASDAQ' },
      { symbol: 'AMZN', exchange: 'NASDAQ' },
      { symbol: 'TSLA', exchange: 'NASDAQ' },
      { symbol: 'META', exchange: 'NASDAQ' },
      { symbol: 'NVDA', exchange: 'NASDAQ' },
      { symbol: 'NFLX', exchange: 'NASDAQ' },
      { symbol: 'AMD', exchange: 'NASDAQ' },
      { symbol: 'INTC', exchange: 'NASDAQ' },
      { symbol: 'PYPL', exchange: 'NASDAQ' },
      { symbol: 'SNAP', exchange: 'NYSE' },
      { symbol: 'UBER', exchange: 'NYSE' },
      { symbol: 'COIN', exchange: 'NASDAQ' },
      { symbol: 'SQ', exchange: 'NYSE' },
      { symbol: 'SHOP', exchange: 'NYSE' },
      { symbol: 'ORCL', exchange: 'NYSE' },
      { symbol: 'ADBE', exchange: 'NASDAQ' },
      { symbol: 'CRM', exchange: 'NYSE' },
      { symbol: 'PLTR', exchange: 'NYSE' }
      // 20 stocks total - batched loading keeps us under rate limits
      // Exchange codes: NASDAQ, NYSE, LSE (London), TSE (Tokyo), HKEX (Hong Kong), ASX (Australia), etc.
    ];

    // Helper function to generate Google Finance URL
    const getGoogleFinanceUrl = (symbol, exchange) => {
      return `https://www.google.com/finance/quote/${symbol}:${exchange}`;
    };

    // Market Hours Helper
    class MarketHours {
      static isMarketOpen() {
        const now = new Date();
        const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = et.getDay();
        const hour = et.getHours();
        const minute = et.getMinutes();
        
        if (day === 0 || day === 6) return false;
        const isMarketHours = (hour === 9 && minute >= 30) || (hour >= 10 && hour < 16);
        return isMarketHours;
      }

      static isWeekend() {
        const now = new Date();
        const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = et.getDay();
        return day === 0 || day === 6;
      }

      static getRefreshInterval() {
        if (this.isWeekend()) return 3600000; // 1 hour on weekends
        if (this.isMarketOpen()) return 120000; // 2 minutes during market hours
        return 900000; // 15 minutes after hours
      }

      static getStatusText() {
        if (this.isWeekend()) return 'üìÖ Weekend - Market Closed';
        if (this.isMarketOpen()) return 'üü¢ Market Open';
        return 'üî¥ Market Closed';
      }
    }

    class DataCache {
      constructor(expiryMs = 60000) {
        this.cache = new Map();
        this.expiryMs = expiryMs;
      }
      
      get(key) {
        const item = this.cache.get(key);
        if (!item) return null;
        const age = Date.now() - item.timestamp;
        if (age < this.expiryMs) return item.data;
        this.cache.delete(key);
        return null;
      }
      
      set(key, data) {
        this.cache.set(key, { data, timestamp: Date.now() });
      }
    }

    // Hybrid API Service - All calls go through serverless (secure!)
    class HybridStockService {
      constructor() {
        // No API keys needed in frontend anymore!
        
        // Separate caches for different data types
        this.quoteCache = new DataCache(30000);        // 30 sec for quotes (frequent updates)
        this.profileCache = new DataCache(3600000);    // 1 hour for profiles (rarely change)
        this.historyCache = new DataCache(900000);     // 15 min for historical (don't need constant updates)
      }

      // üîß IMPROVED: Better retry logic with rate limit handling
      async fetchWithRetry(url, retries = 2) { // Reduced from 3 to 2 retries
        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch(url);
            
            // üö® CRITICAL: Stop immediately on rate limit
            if (response.status === 429) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(`Rate limit exceeded. ${errorData.message || 'Please wait and try again.'}`);
            }
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
          } catch (error) {
            // Don't retry on rate limit errors
            if (error.message.includes('Rate limit')) {
              throw error;
            }
            
            if (i === retries - 1) throw error;
            
            // Exponential backoff with max 3 seconds
            const delay = Math.min(1000 * Math.pow(2, i), 3000);
            console.log(`Retry ${i + 1}/${retries} after ${delay}ms...`);
            await new Promise(r => setTimeout(r, delay));
          }
        }
      }

      // Finnhub: Get real-time quote via serverless
      async getFinnhubQuote(symbol) {
        const cached = this.quoteCache.get(symbol);
        if (cached) return cached;
        
        // ‚úÖ Call serverless function (no exposed API key!)
        const url = `/api/stock-data?symbol=${symbol}&type=quote`;
        const data = await this.fetchWithRetry(url);
        this.quoteCache.set(symbol, data);
        return data;
      }

      // Finnhub: Get company profile via serverless
      async getFinnhubProfile(symbol) {
        const cached = this.profileCache.get(symbol);
        if (cached) return cached;
        
        // ‚úÖ Call serverless function (no exposed API key!)
        const url = `/api/stock-data?symbol=${symbol}&type=profile`;
        const data = await this.fetchWithRetry(url);
        this.profileCache.set(symbol, data);
        return data;
      }

      // Tiingo: Get historical prices via serverless
      async getTiingoHistory(symbol, days = 180) {
        const cacheKey = `${symbol}-hist-${days}`;
        const cached = this.historyCache.get(cacheKey);
        if (cached) return cached;

        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);

        // ‚úÖ Call serverless function (no exposed API key!)
        const url = `/api/stock-data?symbol=${symbol}&type=history&startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`;
        const data = await this.fetchWithRetry(url);
        this.historyCache.set(cacheKey, data);
        return data;
      }

      // Combined: Get all stock data
      async getStockData(symbol) {
        const [quote, profile, history] = await Promise.all([
          this.getFinnhubQuote(symbol),
          this.getFinnhubProfile(symbol),
          this.getTiingoHistory(symbol, 180)
        ]);

        return { quote, profile, history };
      }
    }

    const TechnicalAnalysis = {
      calculateRSI(prices, period = 14) {
        if (prices.length < period + 1) return null;
        let gains = 0, losses = 0;
        
        for (let i = 1; i <= period; i++) {
          const diff = prices[i] - prices[i - 1];
          if (diff >= 0) gains += diff;
          else losses -= diff;
        }

        let avgGain = gains / period;
        let avgLoss = losses / period;

        for (let i = period + 1; i < prices.length; i++) {
          const diff = prices[i] - prices[i - 1];
          if (diff >= 0) {
            avgGain = (avgGain * (period - 1) + diff) / period;
            avgLoss = (avgLoss * (period - 1)) / period;
          } else {
            avgGain = (avgGain * (period - 1)) / period;
            avgLoss = (avgLoss * (period - 1) - diff) / period;
          }
        }

        const rs = avgGain / avgLoss;
        return 100 - (100 / (1 + rs));
      },

      calculateSMA(prices, period) {
        if (prices.length < period) return null;
        return prices.slice(-period).reduce((a, b) => a + b, 0) / period;
      }
    };

    class QuantScorer {
      static calculateTechnicalScore(stockData) {
        let score = 0;
        const { quote, rsi, sma20, sma50, profile } = stockData;

        // RSI Component (30 points)
        if (rsi) {
          if (rsi >= 50 && rsi <= 70) score += 30;
          else if (rsi >= 40 && rsi < 50) score += 25;
          else if (rsi < 40) score += 20;
          else if (rsi > 70 && rsi <= 75) score += 15;
          else score += 10;
        }

        // Price Momentum (25 points)
        const changePercent = quote.dp || 0;
        if (changePercent > 3) score += 25;
        else if (changePercent > 1) score += 20;
        else if (changePercent > 0) score += 15;
        else if (changePercent > -2) score += 10;
        else score += 5;

        // Moving Average Trend (20 points)
        if (sma20 && sma50 && quote.c) {
          if (quote.c > sma20 && sma20 > sma50) score += 20;
          else if (quote.c > sma20) score += 15;
          else if (quote.c > sma50) score += 10;
          else score += 5;
        }

        // Volume Analysis (15 points)
        if (quote.c && quote.pc) {
          const priceChange = Math.abs(quote.c - quote.pc);
          const volatility = (priceChange / quote.pc) * 100;
          if (volatility > 5) score += 15;
          else if (volatility > 3) score += 12;
          else if (volatility > 1) score += 10;
          else score += 5;
        }

        // Market Cap Stability (10 points)
        if (profile?.marketCapitalization) {
          const cap = profile.marketCapitalization * 1e6;
          if (cap > 100e9) score += 10;
          else if (cap > 10e9) score += 8;
          else score += 6;
        }

        return Math.min(Math.round(score), 100);
      }

      static getRecommendation(score) {
        if (score >= 85) return 'Strong Buy';
        if (score >= 75) return 'Buy (4)';
        if (score >= 65) return 'Buy (3)';
        if (score >= 55) return 'Buy (2)';
        if (score >= 45) return 'Hold';
        return 'Sell';
      }
    }

    const StockTracker = () => {
      const [activeTab, setActiveTab] = useState('strong-buy');
      const [stockData, setStockData] = useState({
        strongBuys: [],
        significantDrops: [],
        allStocks: [],
        loading: true,
        error: null
      });
      const [refreshTime, setRefreshTime] = useState(new Date());
      const [isRefreshing, setIsRefreshing] = useState(false);
      const [marketStatus, setMarketStatus] = useState(MarketHours.getStatusText());
      const [loadingProgress, setLoadingProgress] = useState({ current: 0, total: WATCHLIST.length });
      const [showRSIInfo, setShowRSIInfo] = useState(false);
      const [showScoreInfo, setShowScoreInfo] = useState(false);
      
      const stockService = new HybridStockService(); // No API keys needed!

      // üöÄ IMPROVED: Better batching with progress tracking
      const fetchStockData = async (isInitialLoad = false) => {
        if (isInitialLoad) {
          setStockData(prev => ({ ...prev, loading: true }));
        } else {
          setIsRefreshing(true);
        }
        
        try {
          const strongBuys = [];
          const significantDrops = [];
          const allStocks = [];
          
          // üîß OPTIMIZED BATCHING CONFIGURATION (20 stocks)
          const BATCH_SIZE = 4;  // 4 stocks per batch = 5 batches total
          const DELAY_BETWEEN_BATCHES = 2000;  // 2 seconds between batches
          const DELAY_BETWEEN_STOCKS = 500;  // 500ms delay between individual stocks
          
          console.log(`üîÑ Loading ${WATCHLIST.length} stocks in batches of ${BATCH_SIZE}...`);
          
          // Process in smaller batches with longer delays
          for (let i = 0; i < WATCHLIST.length; i += BATCH_SIZE) {
            const batch = WATCHLIST.slice(i, i + BATCH_SIZE);
            const batchNumber = Math.floor(i / BATCH_SIZE) + 1;
            const totalBatches = Math.ceil(WATCHLIST.length / BATCH_SIZE);
            
            console.log(`üì¶ Batch ${batchNumber}/${totalBatches}: ${batch.map(s => s.symbol).join(', ')}`);
            
            // Process each stock in the batch SEQUENTIALLY (not parallel) with delays
            for (const stock of batch) {
              const { symbol, exchange } = stock;
              try {
                setLoadingProgress({ 
                  current: allStocks.length + 1, 
                  total: WATCHLIST.length 
                });
                
                // Get data from both APIs
                const { quote, profile, history } = await stockService.getStockData(symbol);

                if (!quote || quote.c === 0 || !profile?.name) {
                  console.warn(`‚ö†Ô∏è Skipping ${symbol} - invalid data`);
                  continue;
                }

                // Calculate technical indicators from Tiingo historical data
                const closePrices = history.map(h => h.close);
                const rsi = TechnicalAnalysis.calculateRSI(closePrices);
                const sma20 = TechnicalAnalysis.calculateSMA(closePrices, 20);
                const sma50 = TechnicalAnalysis.calculateSMA(closePrices, 50);
                
                // Calculate 3-month and 6-month highs for drop detection
                const threeMonthPrices = closePrices.slice(-90); // Last 90 days
                const sixMonthPrices = closePrices; // All 180 days
                const threeMonthHigh = Math.max(...threeMonthPrices);
                const sixMonthHigh = Math.max(...sixMonthPrices);
                const dropPercentage = ((threeMonthHigh - quote.c) / threeMonthHigh) * 100;

                const stockInfo = {
                  symbol,
                  exchange,
                  company: profile.name,
                  price: quote.c,
                  change: `${quote.dp > 0 ? '+' : ''}${quote.dp?.toFixed(2) || '0.00'}%`,
                  changeValue: quote.dp || 0,
                  marketCap: formatMarketCap(profile.marketCapitalization * 1e6),
                  rsi: rsi ? rsi.toFixed(1) : 'N/A',
                  techScore: 0,
                  prediction: 'Hold',
                  dropValue: dropPercentage,
                  high: quote.h,
                  low: quote.l,
                  threeMonthHigh: threeMonthHigh,
                  sixMonthHigh: sixMonthHigh
                };

                // Calculate technical score
                const techScore = QuantScorer.calculateTechnicalScore({
                  quote,
                  rsi,
                  sma20,
                  sma50,
                  profile
                });
                
                stockInfo.techScore = techScore;
                stockInfo.prediction = QuantScorer.getRecommendation(techScore);

                allStocks.push(stockInfo);
                
                // Categorize stocks
                if (techScore >= 75) {
                  strongBuys.push(stockInfo);
                }
                
                if (dropPercentage >= 15 && closePrices.length > 0) {
                  significantDrops.push({
                    ...stockInfo,
                    drop: `-${dropPercentage.toFixed(1)}%`,
                    threeMonthHigh: threeMonthHigh.toFixed(2)
                  });
                }

                console.log(`‚úÖ ${symbol} loaded successfully (${allStocks.length}/${WATCHLIST.length})`);
                
                // üîß CRITICAL: Delay between individual stocks within batch
                if (batch.indexOf(stock) < batch.length - 1) {
                  await new Promise(r => setTimeout(r, DELAY_BETWEEN_STOCKS));
                }

              } catch (error) {
                console.error(`‚ùå Error processing ${symbol}:`, error);
                
                // If we hit rate limit, show error and stop
                if (error.message.includes('Rate limit')) {
                  setStockData(prev => ({
                    ...prev,
                    loading: false,
                    error: `‚ö†Ô∏è Rate limit reached after loading ${allStocks.length} stocks. Please wait a few minutes before refreshing.`
                  }));
                  setIsRefreshing(false);
                  return; // Stop processing
                }
              }
            }

            // üîß CRITICAL: Longer delay between batches (except for last batch)
            if (i + BATCH_SIZE < WATCHLIST.length) {
              console.log(`‚è≥ Waiting ${DELAY_BETWEEN_BATCHES/1000}s before next batch...`);
              await new Promise(r => setTimeout(r, DELAY_BETWEEN_BATCHES));
            }
          }

          // Sort results
          strongBuys.sort((a, b) => b.techScore - a.techScore);
          significantDrops.sort((a, b) => b.dropValue - a.dropValue);
          allStocks.sort((a, b) => b.changeValue - a.changeValue);

          console.log(`‚úÖ Successfully loaded ${allStocks.length} stocks!`);

          setStockData({
            strongBuys,
            significantDrops,
            allStocks,
            loading: false,
            error: null
          });
          setRefreshTime(new Date());
          setMarketStatus(MarketHours.getStatusText());

        } catch (error) {
          console.error('Fetch error:', error);
          setStockData(prev => ({
            ...prev,
            loading: false,
            error: error.message.includes('Rate limit') 
              ? '‚ö†Ô∏è Rate limit exceeded. Please wait a few minutes before refreshing.'
              : 'Failed to fetch stock data. Please check your API configuration.'
          }));
        } finally {
          setIsRefreshing(false);
          setLoadingProgress({ current: 0, total: WATCHLIST.length });
        }
      };

      useEffect(() => {
        fetchStockData(true); // Initial load

        // Smart refresh based on market hours
        const setupRefresh = () => {
          const interval = MarketHours.getRefreshInterval();
          return setInterval(() => {
            fetchStockData(false);
          }, interval);
        };

        let refreshInterval = setupRefresh();

        // Adjust refresh interval every 5 minutes based on market status
        const adjustInterval = setInterval(() => {
          clearInterval(refreshInterval);
          refreshInterval = setupRefresh();
          setMarketStatus(MarketHours.getStatusText());
        }, 300000); // Check every 5 minutes

        return () => {
          clearInterval(refreshInterval);
          clearInterval(adjustInterval);
        };
      }, []);

      const formatMarketCap = (cap) => {
        if (!cap) return 'N/A';
        if (cap >= 1e12) return `${(cap / 1e12).toFixed(2)}T`;
        if (cap >= 1e9) return `${(cap / 1e9).toFixed(2)}B`;
        if (cap >= 1e6) return `${(cap / 1e6).toFixed(2)}M`;
        return cap.toString();
      };

      // Only show full loading screen on initial load
      if (stockData.loading && stockData.allStocks.length === 0) {
        return (
          <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center">
            <div className="text-center">
              <div className="text-6xl mb-4 animate-pulse">üìä</div>
              <p className="text-xl">Loading live stock data...</p>
              <p className="text-sm text-gray-400 mt-2">
                Analyzing {WATCHLIST.length} stocks ‚Ä¢ Processing in batches
              </p>
              {loadingProgress.current > 0 && (
                <div className="mt-4">
                  <div className="bg-gray-700 rounded-full h-2 w-64 mx-auto">
                    <div 
                      className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                      style={{ width: `${(loadingProgress.current / loadingProgress.total) * 100}%` }}
                    ></div>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">
                    {loadingProgress.current} / {loadingProgress.total} stocks loaded
                  </p>
                </div>
              )}
              <p className="text-xs text-gray-500 mt-4">üîí Secure serverless API - All keys protected</p>
              <p className="text-xs text-gray-500 mt-1">‚è±Ô∏è Rate-limited batching to respect API limits</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-900 text-white p-4 md:p-6">
          {/* Info Modals */}
          <InfoModal isOpen={showRSIInfo} onClose={() => setShowRSIInfo(false)} title="üìä Understanding RSI">
            <RSIInfoContent />
          </InfoModal>

          <InfoModal isOpen={showScoreInfo} onClose={() => setShowScoreInfo(false)} title="üéØ Understanding Tech Score">
            <TechScoreInfoContent />
          </InfoModal>

          {/* Updating Banner */}
          {isRefreshing && (
            <div className="fixed top-0 left-0 right-0 bg-blue-600 text-white text-center py-2 z-50 animate-pulse">
              üîÑ Updating stock data... {loadingProgress.current > 0 && `(${loadingProgress.current}/${loadingProgress.total})`}
            </div>
          )}

          <div className={`mb-8 ${isRefreshing ? 'mt-12' : ''}`}>
            <div className="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
              <h1 className="text-2xl md:text-3xl font-bold">üìà Live Stock Tracker</h1>
              <div className="flex items-center gap-4 flex-wrap">
                <span className="text-sm px-3 py-1 bg-gray-800 rounded-lg">{marketStatus}</span>
                <button
                  onClick={() => fetchStockData(false)}
                  disabled={isRefreshing}
                  className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg disabled:opacity-50 transition-colors"
                >
                  {isRefreshing ? 'üîÑ' : '‚Üª'} Refresh
                </button>
                <div className="text-sm text-gray-400">
                  {refreshTime.toLocaleTimeString()}
                </div>
              </div>
            </div>

            {stockData.error && (
              <div className="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4">
                {stockData.error}
              </div>
            )}
            
            <div className="flex gap-2 md:gap-4 border-b border-gray-700 overflow-x-auto">
              <button
                onClick={() => setActiveTab('strong-buy')}
                className={`pb-2 px-3 md:px-4 font-medium whitespace-nowrap transition-colors ${
                  activeTab === 'strong-buy' 
                    ? 'text-green-400 border-b-2 border-green-400' 
                    : 'text-gray-400 hover:text-white'
                }`}
              >
                üìà Strong Buy ({stockData.strongBuys.length})
              </button>
              <button
                onClick={() => setActiveTab('significant-drops')}
                className={`pb-2 px-3 md:px-4 font-medium whitespace-nowrap transition-colors ${
                  activeTab === 'significant-drops' 
                    ? 'text-red-400 border-b-2 border-red-400' 
                    : 'text-gray-400 hover:text-white'
                }`}
              >
                üìâ Drops &gt;15% ({stockData.significantDrops.length})
              </button>
              <button
                onClick={() => setActiveTab('all-stocks')}
                className={`pb-2 px-3 md:px-4 font-medium whitespace-nowrap transition-colors ${
                  activeTab === 'all-stocks' 
                    ? 'text-blue-400 border-b-2 border-blue-400' 
                    : 'text-gray-400 hover:text-white'
                }`}
              >
                üìä All Stocks ({stockData.allStocks.length})
              </button>
            </div>
          </div>

          {/* Strong Buy Tab */}
          {activeTab === 'strong-buy' && (
            <div className="bg-gray-800 rounded-lg overflow-hidden">
              <div className="bg-green-600 px-4 md:px-6 py-3">
                <h2 className="text-lg font-semibold">üéØ Strong Buy Signals ({stockData.strongBuys.length} stocks)</h2>
              </div>
              
              {stockData.strongBuys.length === 0 ? (
                <div className="px-6 py-8 text-center text-gray-400">
                  No strong buy signals detected at this time. Market conditions may not be favorable.
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-700">
                      <tr>
                        <th className="px-3 py-3 text-left text-xs uppercase">Symbol</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Company</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Price</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">24H Change</th>
                        <th className="px-3 py-3 text-left text-xs uppercase hidden md:table-cell">Market Cap</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">RSI</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Score</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Signal</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-600">
                      {stockData.strongBuys.map((s, i) => (
                        <tr key={i} className="hover:bg-gray-700 transition-colors">
                          <td className="px-3 py-4">
                            <a 
                              href={getGoogleFinanceUrl(s.symbol, s.exchange)} 
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="text-blue-400 font-semibold hover:text-blue-300 hover:underline"
                            >
                              {s.symbol}
                            </a>
                          </td>
                          <td className="px-3 py-4 max-w-[120px] truncate text-xs md:text-sm">{s.company}</td>
                          <td className="px-3 py-4 font-medium">${s.price.toFixed(2)}</td>
                          <td className={`px-3 py-4 font-medium ${s.change.startsWith('+') ? 'text-green-400' : 'text-red-400'}`}>
                            {s.change}
                          </td>
                          <td className="px-3 py-4 hidden md:table-cell">{s.marketCap}</td>
                          <td className={`px-3 py-4 font-medium ${
                            s.rsi === 'N/A' ? 'text-gray-400' : 
                            parseFloat(s.rsi) >= 70 ? 'text-red-400' :
                            parseFloat(s.rsi) <= 30 ? 'text-green-400' : 'text-blue-400'
                          }`}>
                            {s.rsi}
                          </td>
                          <td className={`px-3 py-4 font-bold ${
                            s.techScore >= 80 ? 'text-green-400' :
                            s.techScore >= 60 ? 'text-yellow-400' : 'text-gray-400'
                          }`}>
                            {s.techScore}
                          </td>
                          <td className="px-3 py-4">
                            <span className="bg-green-600 text-green-100 px-2 py-1 rounded text-xs font-medium">
                              {s.prediction}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {/* Significant Drops Tab */}
          {activeTab === 'significant-drops' && (
            <div className="bg-gray-800 rounded-lg overflow-hidden">
              <div className="bg-red-600 px-4 md:px-6 py-3">
                <h2 className="text-lg font-semibold">‚ö†Ô∏è Significant Drops (&gt;15%)</h2>
              </div>
              
              {stockData.significantDrops.length === 0 ? (
                <div className="px-6 py-8 text-center text-gray-400">
                  No significant drops detected. All stocks within 15% of 3-month highs.
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-700">
                      <tr>
                        <th className="px-3 py-3 text-left text-xs uppercase">Symbol</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Company</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Price</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">24H Change</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Drop</th>
                        <th className="px-3 py-3 text-left text-xs uppercase hidden md:table-cell">3M High</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">RSI</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Signal</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-600">
                      {stockData.significantDrops.map((s, i) => (
                        <tr key={i} className="hover:bg-gray-700 transition-colors">
                          <td className="px-3 py-4">
                            <a 
                              href={getGoogleFinanceUrl(s.symbol, s.exchange)} 
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="text-blue-400 font-semibold hover:text-blue-300 hover:underline"
                            >
                              {s.symbol}
                            </a>
                          </td>
                          <td className="px-3 py-4 max-w-[120px] truncate text-xs md:text-sm">{s.company}</td>
                          <td className="px-3 py-4 font-medium">${s.price.toFixed(2)}</td>
                          <td className={`px-3 py-4 font-medium ${s.change.startsWith('+') ? 'text-green-400' : 'text-red-400'}`}>
                            {s.change}
                          </td>
                          <td className="px-3 py-4 font-medium text-red-400">{s.drop}</td>
                          <td className="px-3 py-4 hidden md:table-cell">${s.threeMonthHigh}</td>
                          <td className={`px-3 py-4 font-medium ${
                            s.rsi === 'N/A' ? 'text-gray-400' :
                            parseFloat(s.rsi) >= 70 ? 'text-red-400' :
                            parseFloat(s.rsi) <= 30 ? 'text-green-400' : 'text-blue-400'
                          }`}>
                            {s.rsi}
                          </td>
                          <td className="px-3 py-4">
                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                              s.prediction.includes('Buy') ? 'bg-green-600 text-green-100' : 
                              s.prediction === 'Hold' ? 'bg-yellow-600 text-yellow-100' :
                              'bg-red-600 text-red-100'
                            }`}>
                              {s.prediction}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {/* All Stocks Tab */}
          {activeTab === 'all-stocks' && (
            <div className="bg-gray-800 rounded-lg overflow-hidden">
              <div className="bg-blue-600 px-4 md:px-6 py-3">
                <h2 className="text-lg font-semibold">üìä All Tracked Stocks</h2>
              </div>
              
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-gray-700">
                    <tr>
                      <th className="px-3 py-3 text-left text-xs uppercase">Symbol</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">Company</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">Price</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">24H Change</th>
                      <th className="px-3 py-3 text-left text-xs uppercase hidden md:table-cell">3M High</th>
                      <th className="px-3 py-3 text-left text-xs uppercase hidden lg:table-cell">6M High</th>
                      <th className="px-3 py-3 text-left text-xs uppercase hidden md:table-cell">Market Cap</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">RSI</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">Score</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">Signal</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-600">
                    {stockData.allStocks.map((s, i) => (
                      <tr key={i} className="hover:bg-gray-700 transition-colors">
                        <td className="px-3 py-4">
                          <a 
                            href={getGoogleFinanceUrl(s.symbol, s.exchange)} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-blue-400 font-semibold hover:text-blue-300 hover:underline"
                          >
                            {s.symbol}
                          </a>
                        </td>
                        <td className="px-3 py-4 max-w-[120px] truncate text-xs md:text-sm">{s.company}</td>
                        <td className="px-3 py-4 font-medium">${s.price.toFixed(2)}</td>
                        <td className={`px-3 py-4 font-medium ${s.change.startsWith('+') ? 'text-green-400' : 'text-red-400'}`}>
                          {s.change}
                        </td>
                        <td className="px-3 py-4 hidden md:table-cell">${s.threeMonthHigh.toFixed(2)}</td>
                        <td className="px-3 py-4 hidden lg:table-cell">${s.sixMonthHigh.toFixed(2)}</td>
                        <td className="px-3 py-4 hidden md:table-cell">{s.marketCap}</td>
                        <td className={`px-3 py-4 font-medium ${
                          s.rsi === 'N/A' ? 'text-gray-400' :
                          parseFloat(s.rsi) >= 70 ? 'text-red-400' :
                          parseFloat(s.rsi) <= 30 ? 'text-green-400' : 'text-blue-400'
                        }`}>
                          {s.rsi}
                        </td>
                        <td className={`px-3 py-4 font-bold ${
                          s.techScore >= 80 ? 'text-green-400' :
                          s.techScore >= 60 ? 'text-yellow-400' : 'text-gray-400'
                        }`}>
                          {s.techScore}
                        </td>
                        <td className="px-3 py-4">
                          <span className={`px-2 py-1 rounded text-xs font-medium ${
                            s.prediction.includes('Buy') ? 'bg-green-600 text-green-100' :
                            s.prediction === 'Hold' ? 'bg-yellow-600 text-yellow-100' :
                            'bg-red-600 text-red-100'
                          }`}>
                            {s.prediction}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Enhanced Footer with Info Buttons */}
          <div className="mt-8 space-y-3">
            <div className="text-center text-gray-400 text-xs">
              <p>
                üí∞ Live Data: Finnhub (quotes) + Tiingo (historical) ‚Ä¢ All via secure serverless API ‚Ä¢ Auto-refresh: {
                  MarketHours.isWeekend() ? '1 hour (weekend)' : 
                  MarketHours.isMarketOpen() ? '2 min (market open)' : 
                  '15 min (after hours)'
                }
              </p>
            </div>

            {/* RSI Explanation with Info Button */}
            <div className="flex items-center justify-center gap-2 text-xs">
              <div className="flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-lg">
                <span className="text-green-400">RSI &lt;30</span> = Oversold | 
                <span className="text-blue-400"> 30-70</span> = Neutral | 
                <span className="text-red-400"> &gt;70</span> = Overbought
                <button 
                  onClick={() => setShowRSIInfo(true)}
                  className="ml-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold transition-colors"
                  title="Learn more about RSI"
                >
                  ?
                </button>
              </div>
            </div>

            {/* Tech Score Explanation with Info Button */}
            <div className="flex items-center justify-center gap-2 text-xs">
              <div className="flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-lg">
                <span className="text-gray-300">Tech Score: RSI + Momentum + Moving Averages + Volatility + Market Cap</span>
                <button 
                  onClick={() => setShowScoreInfo(true)}
                  className="ml-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold transition-colors"
                  title="Learn more about Tech Score"
                >
                  ?
                </button>
              </div>
            </div>

            <div className="text-center text-xs space-y-1">
              <p className="text-green-400 font-medium">üîí Fully Secure - All API keys protected via serverless!</p>
              <p className="text-yellow-400 font-medium">‚ö° Batched Loading - Respects API rate limits (4 stocks/batch, 2s delay)</p>
            </div>
          </div>
        </div>
      );
    };
    
    ReactDOM.render(<StockTracker />, document.getElementById('root'));
  </script>
</body>
</html>
