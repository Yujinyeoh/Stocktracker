<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Stock Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Info Modal Component
    const InfoModal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
            <div className="sticky top-0 bg-gray-700 px-6 py-4 flex justify-between items-center border-b border-gray-600">
              <h3 className="text-xl font-bold">{title}</h3>
              <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div className="p-6 text-sm">
              {children}
            </div>
          </div>
        </div>
      );
    };

    // RSI Info Content
    const RSIInfoContent = () => (
      <div className="space-y-4">
        <div>
          <h4 className="font-bold text-lg mb-2">What is RSI?</h4>
          <p className="text-gray-300">
            RSI (Relative Strength Index) measures momentum by comparing recent gains to losses over the last 14 days. It's a number between 0-100.
          </p>
        </div>

        <div className="bg-gray-700 p-4 rounded-lg">
          <h4 className="font-bold mb-3">Understanding RSI Zones:</h4>
          
          <div className="space-y-3">
            <div className="flex items-start gap-3">
              <span className="text-green-400 font-bold text-xl">üü¢</span>
              <div>
                <p className="font-semibold text-green-400">RSI &lt; 30: Oversold</p>
                <p className="text-gray-300 text-xs mt-1">Stock has been falling rapidly. May be undervalued and could bounce back soon. Potential buying opportunity.</p>
              </div>
            </div>

            <div className="flex items-start gap-3">
              <span className="text-blue-400 font-bold text-xl">üîµ</span>
              <div>
                <p className="font-semibold text-blue-400">RSI 30-70: Neutral</p>
                <p className="text-gray-300 text-xs mt-1">Balanced momentum. Normal trading range with no extreme conditions. Most stocks fall in this range.</p>
              </div>
            </div>

            <div className="flex items-start gap-3">
              <span className="text-red-400 font-bold text-xl">üî¥</span>
              <div>
                <p className="font-semibold text-red-400">RSI &gt; 70: Overbought</p>
                <p className="text-gray-300 text-xs mt-1">Stock has been rising rapidly. May be overvalued and could pull back soon. Consider taking profits.</p>
              </div>
            </div>
          </div>
        </div>

        <div>
          <h4 className="font-bold mb-2">Example:</h4>
          <div className="bg-gray-900 p-3 rounded text-xs space-y-2">
            <p><span className="text-yellow-400">TSLA RSI = 25</span> ‚Üí Stock dropped from $240 to $220 over 2 weeks. Heavy selling pressure. May recover soon. üü¢</p>
            <p><span className="text-yellow-400">NVDA RSI = 80</span> ‚Üí Stock rose from $450 to $490 over 2 weeks. Strong buying pressure. May cool off soon. üî¥</p>
          </div>
        </div>

        <div className="bg-yellow-900 bg-opacity-30 border border-yellow-700 p-3 rounded">
          <p className="text-yellow-200 text-xs">
            ‚ö†Ô∏è <strong>Note:</strong> RSI is just one indicator. Always combine it with other analysis and research before making investment decisions.
          </p>
        </div>
      </div>
    );

    // Quant Score Info Content
    const TechScoreInfoContent = () => (
      <div className="space-y-4">
        <div>
          <h4 className="font-bold text-lg mb-2">What is the Quant Score?</h4>
          <p className="text-gray-300">
            Our Quantitative Score (0-100) uses a sophisticated multi-factor model that combines statistical analysis, risk metrics, and quantitative indicators. This goes beyond simple technical analysis to provide a data-driven assessment of each stock's potential.
          </p>
        </div>

        <div className="bg-gray-700 p-4 rounded-lg">
          <h4 className="font-bold mb-3">Multi-Factor Model Breakdown:</h4>
          
          <div className="space-y-3">
            <div>
              <p className="font-semibold text-blue-400">1Ô∏è‚É£ Momentum Factor (25%)</p>
              <p className="text-gray-300 text-xs mt-1">
                Analyzes price momentum over 5, 10, and 20-day periods with weighted averages. Recent momentum weighted more heavily than older data.
              </p>
            </div>

            <div>
              <p className="font-semibold text-blue-400">2Ô∏è‚É£ Mean Reversion Factor (20%)</p>
              <p className="text-gray-300 text-xs mt-1">
                Uses Bollinger Bands and moving average distances to identify oversold/overbought conditions. Stocks near lower bands score higher (potential bounce).
              </p>
            </div>

            <div>
              <p className="font-semibold text-blue-400">3Ô∏è‚É£ Trend Strength Factor (25%)</p>
              <p className="text-gray-300 text-xs mt-1">
                Evaluates trend alignment (Golden Cross patterns), trend consistency, and moving average slopes to measure trend quality and sustainability.
              </p>
            </div>

            <div>
              <p className="font-semibold text-blue-400">4Ô∏è‚É£ Risk-Adjusted Returns (15%)</p>
              <p className="text-gray-300 text-xs mt-1">
                Calculates Sharpe and Sortino-like ratios to measure returns relative to volatility and downside risk. Rewards consistent gains with low risk.
              </p>
            </div>

            <div>
              <p className="font-semibold text-blue-400">5Ô∏è‚É£ Value Factor (15%)</p>
              <p className="text-gray-300 text-xs mt-1">
                Analyzes distance from 3M/6M highs and support levels to identify value opportunities. Stocks at significant discounts score higher.
              </p>
            </div>
          </div>
        </div>

        <div className="bg-gray-700 p-4 rounded-lg">
          <h4 className="font-bold mb-3">Signal Classifications:</h4>
          <div className="space-y-2 text-xs">
            <p><span className="bg-green-600 px-2 py-1 rounded font-semibold">80-100</span> <span className="text-green-400">Strong Buy (High Confidence)</span> - Multiple factors strongly aligned</p>
            <p><span className="bg-green-700 px-2 py-1 rounded font-semibold">70-79</span> <span className="text-green-400">Buy (High Confidence)</span> - Most factors positive</p>
            <p><span className="bg-green-800 px-2 py-1 rounded font-semibold">60-69</span> <span className="text-green-300">Buy (Medium Confidence)</span> - Favorable conditions</p>
            <p><span className="bg-yellow-600 px-2 py-1 rounded font-semibold">55-59</span> <span className="text-yellow-400">Weak Buy (Low Confidence)</span> - Slightly positive signals</p>
            <p><span className="bg-yellow-700 px-2 py-1 rounded font-semibold">45-54</span> <span className="text-yellow-300">Hold (Neutral)</span> - Mixed signals, wait for clarity</p>
            <p><span className="bg-orange-600 px-2 py-1 rounded font-semibold">35-44</span> <span className="text-orange-400">Weak Sell (Low Confidence)</span> - Slightly negative signals</p>
            <p><span className="bg-red-600 px-2 py-1 rounded font-semibold">0-34</span> <span className="text-red-400">Sell (High Confidence)</span> - Multiple negative factors</p>
          </div>
        </div>

        <div>
          <h4 className="font-bold mb-2">Advanced Features:</h4>
          <div className="bg-gray-900 p-3 rounded text-xs space-y-2">
            <p><strong>Bollinger Bands:</strong> Statistical bands that identify when prices are stretched relative to their moving average.</p>
            <p><strong>Sharpe Ratio:</strong> Measures return per unit of total risk (volatility).</p>
            <p><strong>Sortino Ratio:</strong> Similar to Sharpe but only considers downside volatility (more relevant for investors).</p>
            <p><strong>Support Levels:</strong> Historical price floors where buying pressure typically emerges.</p>
            <p><strong>Golden Cross:</strong> Bullish pattern when price > 20-day MA > 50-day MA.</p>
          </div>
        </div>

        <div>
          <h4 className="font-bold mb-2">Example Calculation:</h4>
          <div className="bg-gray-900 p-3 rounded text-xs space-y-1">
            <p className="text-yellow-400 font-semibold">NVDA with 85/100 Score:</p>
            <p>‚Ä¢ Momentum: 82/100 (25% weight) ‚Üí 20.5 pts üü¢</p>
            <p>‚Ä¢ Mean Reversion: 55/100 (20% weight) ‚Üí 11.0 pts üü°</p>
            <p>‚Ä¢ Trend Strength: 90/100 (25% weight) ‚Üí 22.5 pts üü¢</p>
            <p>‚Ä¢ Risk-Adjusted: 75/100 (15% weight) ‚Üí 11.3 pts üü¢</p>
            <p>‚Ä¢ Value: 70/100 (15% weight) ‚Üí 10.5 pts üü¢</p>
            <p>‚Ä¢ Market Cap Bonus: +5 pts (large cap) ‚úÖ</p>
            <p className="text-green-400 font-semibold mt-2">Total: 85/100 = STRONG BUY (High Confidence) üöÄ</p>
          </div>
        </div>

        <div className="bg-blue-900 bg-opacity-30 border border-blue-700 p-3 rounded">
          <p className="text-blue-200 text-xs font-semibold mb-2">
            üí° Why This Is Better Than Simple Technical Analysis:
          </p>
          <ul className="text-blue-200 text-xs space-y-1 ml-4 list-disc">
            <li>Multi-factor approach reduces single-indicator bias</li>
            <li>Risk-adjusted metrics account for volatility</li>
            <li>Statistical models (Bollinger Bands) provide objective thresholds</li>
            <li>Weighted factors emphasize what matters most</li>
            <li>Confidence levels show conviction strength</li>
          </ul>
        </div>

        <div className="bg-red-900 bg-opacity-30 border border-red-700 p-3 rounded">
          <p className="text-red-200 text-xs">
            <strong>‚ö†Ô∏è Important Limitations:</strong> This is a quantitative model based on PRICE DATA ONLY. It does NOT consider:
          </p>
          <ul className="text-red-200 text-xs mt-2 space-y-1 ml-4 list-disc">
            <li>Company fundamentals (earnings, revenue, debt)</li>
            <li>News events, product launches, or management changes</li>
            <li>Macroeconomic conditions or sector rotation</li>
            <li>Competitive landscape or market disruption</li>
            <li>Regulatory changes or geopolitical risks</li>
          </ul>
          <p className="text-red-200 text-xs mt-2 font-semibold">
            Quantitative models are powerful tools but should be combined with fundamental analysis and your own research!
          </p>
        </div>
      </div>
    );
    
    // API Configuration - ALL keys now securely stored in Vercel environment variables!
    // No API keys exposed in frontend code = secure! üîí
    
    // üìä Full stock watchlist with exchange info for Google Finance links
    const WATCHLIST = [
      { symbol: 'AAPL', exchange: 'NASDAQ' },
      { symbol: 'MSFT', exchange: 'NASDAQ' },
      { symbol: 'GOOGL', exchange: 'NASDAQ' },
      { symbol: 'AMZN', exchange: 'NASDAQ' },
      { symbol: 'TSLA', exchange: 'NASDAQ' },
      { symbol: 'META', exchange: 'NASDAQ' },
      { symbol: 'NVDA', exchange: 'NASDAQ' },
      { symbol: 'NFLX', exchange: 'NASDAQ' },
      { symbol: 'AMD', exchange: 'NASDAQ' },
      { symbol: 'INTC', exchange: 'NASDAQ' },
      { symbol: 'PYPL', exchange: 'NASDAQ' },
      { symbol: 'SNAP', exchange: 'NYSE' },
      { symbol: 'UBER', exchange: 'NYSE' },
      { symbol: 'COIN', exchange: 'NASDAQ' },
      { symbol: 'SQ', exchange: 'NYSE' },
      { symbol: 'SHOP', exchange: 'NYSE' },
      { symbol: 'ORCL', exchange: 'NYSE' },
      { symbol: 'ADBE', exchange: 'NASDAQ' },
      { symbol: 'CRM', exchange: 'NYSE' },
      { symbol: 'PLTR', exchange: 'NYSE' }
      // 20 stocks total - batched loading keeps us under rate limits
      // Exchange codes: NASDAQ, NYSE, LSE (London), TSE (Tokyo), HKEX (Hong Kong), ASX (Australia), etc.
    ];

    // Helper function to generate Google Finance URL
    const getGoogleFinanceUrl = (symbol, exchange) => {
      return `https://www.google.com/finance/quote/${symbol}:${exchange}`;
    };

    // Market Hours Helper
    class MarketHours {
      static isMarketOpen() {
        const now = new Date();
        const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = et.getDay();
        const hour = et.getHours();
        const minute = et.getMinutes();
        
        if (day === 0 || day === 6) return false;
        const isMarketHours = (hour === 9 && minute >= 30) || (hour >= 10 && hour < 16);
        return isMarketHours;
      }

      static isWeekend() {
        const now = new Date();
        const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = et.getDay();
        return day === 0 || day === 6;
      }

      static isSundayEvening() {
        const now = new Date();
        const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = et.getDay();
        const hour = et.getHours();
        // Sunday (day 0) after 6 PM ET (pre-market prep)
        return day === 0 && hour >= 18;
      }

      static getRefreshInterval() {
        // Sunday evening: 30 min (preparing for Monday pre-market)
        if (this.isSundayEvening()) return 1800000; // 30 minutes
        
        // Weekend (Sat or Sun before 6 PM): 6 hours (prices don't change!)
        if (this.isWeekend()) return 21600000; // 6 hours (prices frozen)
        
        // Market hours: 2 minutes (active trading)
        if (this.isMarketOpen()) return 120000; // 2 minutes
        
        // After hours weekday: 15 minutes (some activity)
        return 900000; // 15 minutes
      }

      static getStatusText() {
        if (this.isSundayEvening()) return 'üåô Sunday Evening - Preparing for Monday';
        if (this.isWeekend()) return 'üìÖ Weekend - Market Closed (Prices Frozen)';
        if (this.isMarketOpen()) return 'üü¢ Market Open';
        return 'üî¥ Market Closed';
      }

      static getRefreshIntervalText() {
        if (this.isSundayEvening()) return '30 min (Sunday evening)';
        if (this.isWeekend()) return '6 hours (weekend - no trading)';
        if (this.isMarketOpen()) return '2 min (market open)';
        return '15 min (after hours)';
      }
    }

    class DataCache {
      constructor(expiryMs = 60000) {
        this.cache = new Map();
        this.expiryMs = expiryMs;
      }
      
      get(key) {
        const item = this.cache.get(key);
        if (!item) return null;
        const age = Date.now() - item.timestamp;
        if (age < this.expiryMs) return item.data;
        this.cache.delete(key);
        return null;
      }
      
      set(key, data) {
        this.cache.set(key, { data, timestamp: Date.now() });
      }
    }

    // Hybrid API Service - All calls go through serverless (secure!)
    class HybridStockService {
      constructor() {
        // No API keys needed in frontend anymore!
        
        // Separate caches for different data types
        this.quoteCache = new DataCache(30000);        // 30 sec for quotes (frequent updates)
        this.profileCache = new DataCache(3600000);    // 1 hour for profiles (rarely change)
        this.historyCache = new DataCache(900000);     // 15 min for historical (don't need constant updates)
      }

      // üîß IMPROVED: Better retry logic with rate limit handling
      async fetchWithRetry(url, retries = 2) { // Reduced from 3 to 2 retries
        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch(url);
            
            // üö® CRITICAL: Stop immediately on rate limit
            if (response.status === 429) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(`Rate limit exceeded. ${errorData.message || 'Please wait and try again.'}`);
            }
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
          } catch (error) {
            // Don't retry on rate limit errors
            if (error.message.includes('Rate limit')) {
              throw error;
            }
            
            if (i === retries - 1) throw error;
            
            // Exponential backoff with max 3 seconds
            const delay = Math.min(1000 * Math.pow(2, i), 3000);
            console.log(`Retry ${i + 1}/${retries} after ${delay}ms...`);
            await new Promise(r => setTimeout(r, delay));
          }
        }
      }

      // Finnhub: Get real-time quote via serverless
      async getFinnhubQuote(symbol) {
        const cached = this.quoteCache.get(symbol);
        if (cached) return cached;
        
        // ‚úÖ Call serverless function (no exposed API key!)
        const url = `/api/stock-data?symbol=${symbol}&type=quote`;
        const data = await this.fetchWithRetry(url);
        this.quoteCache.set(symbol, data);
        return data;
      }

      // Finnhub: Get company profile via serverless
      async getFinnhubProfile(symbol) {
        const cached = this.profileCache.get(symbol);
        if (cached) return cached;
        
        // ‚úÖ Call serverless function (no exposed API key!)
        const url = `/api/stock-data?symbol=${symbol}&type=profile`;
        const data = await this.fetchWithRetry(url);
        this.profileCache.set(symbol, data);
        return data;
      }

      // Tiingo: Get historical prices via serverless
      async getTiingoHistory(symbol, days = 180) {
        const cacheKey = `${symbol}-hist-${days}`;
        const cached = this.historyCache.get(cacheKey);
        if (cached) return cached;

        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);

        // ‚úÖ Call serverless function (no exposed API key!)
        const url = `/api/stock-data?symbol=${symbol}&type=history&startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`;
        const data = await this.fetchWithRetry(url);
        this.historyCache.set(cacheKey, data);
        return data;
      }

      // Combined: Get all stock data
      async getStockData(symbol) {
        const [quote, profile, history] = await Promise.all([
          this.getFinnhubQuote(symbol),
          this.getFinnhubProfile(symbol),
          this.getTiingoHistory(symbol, 180)
        ]);

        return { quote, profile, history };
      }
    }

    const TechnicalAnalysis = {
      calculateRSI(prices, period = 14) {
        if (prices.length < period + 1) return null;
        let gains = 0, losses = 0;
        
        for (let i = 1; i <= period; i++) {
          const diff = prices[i] - prices[i - 1];
          if (diff >= 0) gains += diff;
          else losses -= diff;
        }

        let avgGain = gains / period;
        let avgLoss = losses / period;

        for (let i = period + 1; i < prices.length; i++) {
          const diff = prices[i] - prices[i - 1];
          if (diff >= 0) {
            avgGain = (avgGain * (period - 1) + diff) / period;
            avgLoss = (avgLoss * (period - 1)) / period;
          } else {
            avgGain = (avgGain * (period - 1)) / period;
            avgLoss = (avgLoss * (period - 1) - diff) / period;
          }
        }

        const rs = avgGain / avgLoss;
        return 100 - (100 / (1 + rs));
      },

      calculateSMA(prices, period) {
        if (prices.length < period) return null;
        return prices.slice(-period).reduce((a, b) => a + b, 0) / period;
      }
    };

    // Advanced Quantitative Models
    const QuantModels = {
      // Calculate Bollinger Bands
      calculateBollingerBands(prices, period = 20, stdDev = 2) {
        const sma = TechnicalAnalysis.calculateSMA(prices, period);
        if (!sma) return null;
        
        const recentPrices = prices.slice(-period);
        const squaredDiffs = recentPrices.map(p => Math.pow(p - sma, 2));
        const variance = squaredDiffs.reduce((a, b) => a + b, 0) / period;
        const std = Math.sqrt(variance);
        
        return {
          middle: sma,
          upper: sma + (stdDev * std),
          lower: sma - (stdDev * std),
          bandwidth: (4 * std) / sma
        };
      },

      // Calculate Price Momentum Score (0-100)
      calculateMomentumScore(prices) {
        if (prices.length < 20) return 50;
        
        const current = prices[prices.length - 1];
        const price5d = prices[prices.length - 6];
        const price10d = prices[prices.length - 11];
        const price20d = prices[prices.length - 21];
        
        const momentum5d = ((current - price5d) / price5d) * 100;
        const momentum10d = ((current - price10d) / price10d) * 100;
        const momentum20d = ((current - price20d) / price20d) * 100;
        
        // Weighted momentum: recent prices matter more
        const weightedMomentum = (momentum5d * 0.5) + (momentum10d * 0.3) + (momentum20d * 0.2);
        
        // Normalize to 0-100 scale (assuming ¬±20% is extreme)
        return Math.max(0, Math.min(100, 50 + (weightedMomentum * 2.5)));
      },

      // Calculate Mean Reversion Score (0-100)
      calculateMeanReversionScore(currentPrice, bb, sma20, sma50) {
        if (!bb || !sma20 || !sma50) return 50;
        
        let score = 0;
        
        // Bollinger Band position (50 points max)
        // Price near lower band = high score (oversold/good buy)
        // Price near upper band = low score (overbought)
        const bbPosition = (currentPrice - bb.lower) / (bb.upper - bb.lower);
        const bbScore = (1 - bbPosition) * 50; // Invert: lower = better
        score += bbScore;
        
        // Moving average distance (50 points max)
        // Price below MAs = potential reversion up = high score
        const distanceFromSMA20 = ((currentPrice - sma20) / sma20) * 100;
        const distanceFromSMA50 = ((currentPrice - sma50) / sma50) * 100;
        
        // If price is below MAs, it might revert up (good for buying)
        const maScore = distanceFromSMA20 < 0 ? 
          Math.min(50, Math.abs(distanceFromSMA20) * 5) : 
          Math.max(0, 50 - (distanceFromSMA20 * 5));
        score += maScore * 0.5;
        
        return Math.max(0, Math.min(100, score));
      },

      // Calculate Trend Strength (0-100)
      calculateTrendStrength(prices, sma20, sma50) {
        if (!sma20 || !sma50 || prices.length < 50) return 50;
        
        let score = 0;
        const current = prices[prices.length - 1];
        
        // Check trend alignment (40 points)
        if (current > sma20 && sma20 > sma50) {
          score += 40; // Strong uptrend
        } else if (current > sma20 && sma20 < sma50) {
          score += 25; // Weak uptrend
        } else if (current < sma20 && sma20 > sma50) {
          score += 15; // Mixed signals
        } else {
          score += 5; // Downtrend
        }
        
        // Trend consistency over last 20 days (30 points)
        const recentPrices = prices.slice(-20);
        let upDays = 0;
        for (let i = 1; i < recentPrices.length; i++) {
          if (recentPrices[i] > recentPrices[i-1]) upDays++;
        }
        const consistency = (upDays / 19) * 30;
        score += consistency;
        
        // Slope of moving averages (30 points)
        const sma20_5ago = TechnicalAnalysis.calculateSMA(prices.slice(0, -5), 20);
        const sma20Slope = sma20_5ago ? ((sma20 - sma20_5ago) / sma20_5ago) * 100 : 0;
        const slopeScore = Math.max(0, Math.min(30, (sma20Slope + 5) * 3));
        score += slopeScore;
        
        return Math.max(0, Math.min(100, score));
      },

      // Calculate Risk-Adjusted Score (0-100)
      calculateRiskAdjustedScore(prices, currentReturn) {
        if (prices.length < 30) return 50;
        
        // Calculate daily returns
        const returns = [];
        for (let i = 1; i < prices.length; i++) {
          returns.push((prices[i] - prices[i-1]) / prices[i-1]);
        }
        
        // Calculate volatility (standard deviation of returns)
        const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
        const squaredDiffs = returns.map(r => Math.pow(r - avgReturn, 2));
        const variance = squaredDiffs.reduce((a, b) => a + b, 0) / returns.length;
        const volatility = Math.sqrt(variance);
        
        // Calculate downside deviation (only negative returns)
        const negativeReturns = returns.filter(r => r < 0);
        const downsideVariance = negativeReturns.length > 0 ?
          negativeReturns.map(r => r * r).reduce((a, b) => a + b, 0) / negativeReturns.length : 0;
        const downsideDeviation = Math.sqrt(downsideVariance);
        
        // Sharpe-like ratio (assuming 0% risk-free rate for simplicity)
        const sharpeRatio = volatility > 0 ? avgReturn / volatility : 0;
        
        // Sortino-like ratio (uses downside deviation)
        const sortinoRatio = downsideDeviation > 0 ? avgReturn / downsideDeviation : 0;
        
        // Score based on risk-adjusted metrics
        let score = 50;
        
        // Reward positive Sharpe ratio (25 points)
        score += Math.max(-25, Math.min(25, sharpeRatio * 500));
        
        // Reward positive Sortino ratio (25 points)
        score += Math.max(-25, Math.min(25, sortinoRatio * 500));
        
        return Math.max(0, Math.min(100, score));
      },

      // Calculate Value Score based on historical highs (0-100)
      calculateValueScore(currentPrice, threeMonthHigh, sixMonthHigh, prices) {
        let score = 0;
        
        // Distance from 3-month high (40 points)
        const distanceFrom3M = ((threeMonthHigh - currentPrice) / threeMonthHigh) * 100;
        if (distanceFrom3M > 20) score += 40; // Deep discount
        else if (distanceFrom3M > 10) score += 30; // Moderate discount
        else if (distanceFrom3M > 5) score += 20; // Small discount
        else if (distanceFrom3M > 0) score += 10; // Near high
        else score += 5; // At new high
        
        // Distance from 6-month high (30 points)
        const distanceFrom6M = ((sixMonthHigh - currentPrice) / sixMonthHigh) * 100;
        if (distanceFrom6M > 30) score += 30; // Very deep discount
        else if (distanceFrom6M > 15) score += 20; // Significant discount
        else if (distanceFrom6M > 5) score += 10; // Moderate discount
        else score += 5; // Near high
        
        // Support level strength (30 points)
        // Check if current price is near historical support
        const recentLows = [];
        for (let i = Math.max(0, prices.length - 60); i < prices.length - 5; i++) {
          if (prices[i] <= prices[i-1] && prices[i] <= prices[i+1]) {
            recentLows.push(prices[i]);
          }
        }
        
        if (recentLows.length > 0) {
          const nearSupport = recentLows.some(low => 
            Math.abs((currentPrice - low) / low) < 0.02 // Within 2% of support
          );
          if (nearSupport) score += 30;
          else score += 15;
        } else {
          score += 10;
        }
        
        return Math.max(0, Math.min(100, score));
      }
    };

    // Multi-Factor Quantitative Scorer
    class QuantScorer {
      static calculateQuantScore(stockData) {
        const { quote, rsi, sma20, sma50, profile, prices, threeMonthHigh, sixMonthHigh } = stockData;
        
        if (!prices || prices.length < 50) {
          console.warn('Insufficient data for quant analysis');
          return this.fallbackScore(stockData);
        }
        
        const currentPrice = quote.c;
        const bb = QuantModels.calculateBollingerBands(prices);
        
        // Calculate all factor scores
        const factors = {
          momentum: QuantModels.calculateMomentumScore(prices),
          meanReversion: QuantModels.calculateMeanReversionScore(currentPrice, bb, sma20, sma50),
          trendStrength: QuantModels.calculateTrendStrength(prices, sma20, sma50),
          riskAdjusted: QuantModels.calculateRiskAdjustedScore(prices, quote.dp),
          value: QuantModels.calculateValueScore(currentPrice, threeMonthHigh, sixMonthHigh, prices)
        };
        
        // Factor weights (must sum to 1.0)
        const weights = {
          momentum: 0.25,      // 25% - Recent price trends
          meanReversion: 0.20, // 20% - Oversold/overbought conditions
          trendStrength: 0.25, // 25% - Overall trend quality
          riskAdjusted: 0.15,  // 15% - Risk-adjusted returns
          value: 0.15          // 15% - Value/discount opportunities
        };
        
        // Calculate weighted composite score
        let compositeScore = 0;
        for (const [factor, score] of Object.entries(factors)) {
          compositeScore += score * weights[factor];
        }
        
        // Add market cap quality adjustment (¬±5 points)
        if (profile?.marketCapitalization) {
          const cap = profile.marketCapitalization * 1e6;
          if (cap > 200e9) compositeScore += 5; // Large cap bonus
          else if (cap > 50e9) compositeScore += 3; // Mid-large cap
          else if (cap < 2e9) compositeScore -= 3; // Small cap penalty (higher risk)
        }
        
        const finalScore = Math.max(0, Math.min(100, Math.round(compositeScore)));
        
        // Store factor breakdown for transparency
        return {
          score: finalScore,
          factors,
          weights,
          bollingerBands: bb
        };
      }

      static fallbackScore(stockData) {
        // Simple fallback if insufficient data
        const { quote, rsi, profile } = stockData;
        let score = 50;
        
        if (rsi && rsi >= 30 && rsi <= 70) score += 20;
        if (quote.dp > 0) score += 15;
        if (profile?.marketCapitalization > 50) score += 15;
        
        return {
          score: Math.min(100, score),
          factors: { fallback: true },
          weights: {},
          bollingerBands: null
        };
      }

      static getRecommendation(quantResult) {
        const score = quantResult.score;
        
        // More nuanced recommendations based on quant score
        if (score >= 80) return { signal: 'Strong Buy', confidence: 'High', color: 'green-600' };
        if (score >= 70) return { signal: 'Buy', confidence: 'High', color: 'green-700' };
        if (score >= 60) return { signal: 'Buy', confidence: 'Medium', color: 'green-800' };
        if (score >= 55) return { signal: 'Weak Buy', confidence: 'Low', color: 'yellow-600' };
        if (score >= 45) return { signal: 'Hold', confidence: 'Neutral', color: 'yellow-700' };
        if (score >= 35) return { signal: 'Weak Sell', confidence: 'Low', color: 'orange-600' };
        return { signal: 'Sell', confidence: 'High', color: 'red-600' };
      }

      static getFactorAnalysis(quantResult) {
        if (!quantResult.factors || quantResult.factors.fallback) {
          return 'Insufficient historical data for detailed factor analysis';
        }
        
        const { factors, weights } = quantResult;
        const analysis = [];
        
        // Analyze each factor
        for (const [name, score] of Object.entries(factors)) {
          const weight = weights[name];
          const contribution = (score * weight).toFixed(1);
          
          let rating = '';
          if (score >= 75) rating = 'üü¢ Strong';
          else if (score >= 60) rating = 'üü° Good';
          else if (score >= 45) rating = '‚ö™ Neutral';
          else if (score >= 30) rating = 'üü† Weak';
          else rating = 'üî¥ Poor';
          
          const formattedName = name.charAt(0).toUpperCase() + name.slice(1).replace(/([A-Z])/g, ' $1');
          analysis.push(`${formattedName}: ${score.toFixed(0)}/100 ${rating} (${contribution} pts)`);
        }
        
        return analysis.join('\n');
      }
    };

    const StockTracker = () => {
      const [activeTab, setActiveTab] = useState('strong-buy');
      const [stockData, setStockData] = useState({
        strongBuys: [],
        significantDrops: [],
        allStocks: [],
        loading: true,
        error: null
      });
      const [refreshTime, setRefreshTime] = useState(new Date());
      const [isRefreshing, setIsRefreshing] = useState(false);
      const [marketStatus, setMarketStatus] = useState(MarketHours.getStatusText());
      const [loadingProgress, setLoadingProgress] = useState({ current: 0, total: WATCHLIST.length });
      const [showRSIInfo, setShowRSIInfo] = useState(false);
      const [showScoreInfo, setShowScoreInfo] = useState(false);
      
      const stockService = new HybridStockService(); // No API keys needed!

      // üöÄ IMPROVED: Better batching with progress tracking
      const fetchStockData = async (isInitialLoad = false) => {
        if (isInitialLoad) {
          setStockData(prev => ({ ...prev, loading: true }));
        } else {
          setIsRefreshing(true);
        }
        
        try {
          const strongBuys = [];
          const significantDrops = [];
          const allStocks = [];
          
          // üîß OPTIMIZED BATCHING CONFIGURATION (20 stocks)
          const BATCH_SIZE = 4;  // 4 stocks per batch = 5 batches total
          const DELAY_BETWEEN_BATCHES = 2000;  // 2 seconds between batches
          const DELAY_BETWEEN_STOCKS = 500;  // 500ms delay between individual stocks
          
          console.log(`üîÑ Loading ${WATCHLIST.length} stocks in batches of ${BATCH_SIZE}...`);
          
          // Process in smaller batches with longer delays
          for (let i = 0; i < WATCHLIST.length; i += BATCH_SIZE) {
            const batch = WATCHLIST.slice(i, i + BATCH_SIZE);
            const batchNumber = Math.floor(i / BATCH_SIZE) + 1;
            const totalBatches = Math.ceil(WATCHLIST.length / BATCH_SIZE);
            
            console.log(`üì¶ Batch ${batchNumber}/${totalBatches}: ${batch.map(s => s.symbol).join(', ')}`);
            
            // Process each stock in the batch SEQUENTIALLY (not parallel) with delays
            for (const stock of batch) {
              const { symbol, exchange } = stock;
              try {
                setLoadingProgress({ 
                  current: allStocks.length + 1, 
                  total: WATCHLIST.length 
                });
                
                // Get data from both APIs
                const { quote, profile, history } = await stockService.getStockData(symbol);

                if (!quote || quote.c === 0 || !profile?.name) {
                  console.warn(`‚ö†Ô∏è Skipping ${symbol} - invalid data`);
                  continue;
                }

                // Calculate technical indicators from Tiingo historical data
                const closePrices = history.map(h => h.close);
                const rsi = TechnicalAnalysis.calculateRSI(closePrices);
                const sma20 = TechnicalAnalysis.calculateSMA(closePrices, 20);
                const sma50 = TechnicalAnalysis.calculateSMA(closePrices, 50);
                
                // Calculate 3-month and 6-month highs for drop detection
                const threeMonthPrices = closePrices.slice(-90); // Last 90 days
                const sixMonthPrices = closePrices; // All 180 days
                const threeMonthHigh = Math.max(...threeMonthPrices);
                const sixMonthHigh = Math.max(...sixMonthPrices);
                const dropPercentage = ((threeMonthHigh - quote.c) / threeMonthHigh) * 100;

                // Calculate quantitative score using multi-factor model
                const quantResult = QuantScorer.calculateQuantScore({
                  quote,
                  rsi,
                  sma20,
                  sma50,
                  profile,
                  prices: closePrices,
                  threeMonthHigh,
                  sixMonthHigh
                });
                
                const recommendation = QuantScorer.getRecommendation(quantResult);

                const stockInfo = {
                  symbol,
                  exchange,
                  company: profile.name,
                  price: quote.c,
                  change: `${quote.dp > 0 ? '+' : ''}${quote.dp?.toFixed(2) || '0.00'}%`,
                  changeValue: quote.dp || 0,
                  marketCap: formatMarketCap(profile.marketCapitalization * 1e6),
                  rsi: rsi ? rsi.toFixed(1) : 'N/A',
                  quantScore: quantResult.score,
                  quantFactors: quantResult.factors,
                  prediction: recommendation.signal,
                  confidence: recommendation.confidence,
                  signalColor: recommendation.color,
                  dropValue: dropPercentage,
                  high: quote.h,
                  low: quote.l,
                  threeMonthHigh: threeMonthHigh,
                  sixMonthHigh: sixMonthHigh
                };

                allStocks.push(stockInfo);
                
                // Categorize stocks based on quant score
                if (quantResult.score >= 70) {
                  strongBuys.push(stockInfo);
                }
                
                if (dropPercentage >= 15 && closePrices.length > 0) {
                  significantDrops.push({
                    ...stockInfo,
                    drop: `-${dropPercentage.toFixed(1)}%`,
                    threeMonthHigh: threeMonthHigh.toFixed(2)
                  });
                }

                console.log(`‚úÖ ${symbol} loaded successfully (${allStocks.length}/${WATCHLIST.length})`);
                
                // üîß CRITICAL: Delay between individual stocks within batch
                if (batch.indexOf(stock) < batch.length - 1) {
                  await new Promise(r => setTimeout(r, DELAY_BETWEEN_STOCKS));
                }

              } catch (error) {
                console.error(`‚ùå Error processing ${symbol}:`, error);
                
                // If we hit rate limit, show error and stop
                if (error.message.includes('Rate limit')) {
                  setStockData(prev => ({
                    ...prev,
                    loading: false,
                    error: `‚ö†Ô∏è Rate limit reached after loading ${allStocks.length} stocks. Please wait a few minutes before refreshing.`
                  }));
                  setIsRefreshing(false);
                  return; // Stop processing
                }
              }
            }

            // üîß CRITICAL: Longer delay between batches (except for last batch)
            if (i + BATCH_SIZE < WATCHLIST.length) {
              console.log(`‚è≥ Waiting ${DELAY_BETWEEN_BATCHES/1000}s before next batch...`);
              await new Promise(r => setTimeout(r, DELAY_BETWEEN_BATCHES));
            }
          }

          // Sort results
          strongBuys.sort((a, b) => b.quantScore - a.quantScore);
          significantDrops.sort((a, b) => b.dropValue - a.dropValue);
          allStocks.sort((a, b) => b.changeValue - a.changeValue);

          console.log(`‚úÖ Successfully loaded ${allStocks.length} stocks!`);

          setStockData({
            strongBuys,
            significantDrops,
            allStocks,
            loading: false,
            error: null
          });
          setRefreshTime(new Date());
          setMarketStatus(MarketHours.getStatusText());

        } catch (error) {
          console.error('Fetch error:', error);
          setStockData(prev => ({
            ...prev,
            loading: false,
            error: error.message.includes('Rate limit') 
              ? '‚ö†Ô∏è Rate limit exceeded. Please wait a few minutes before refreshing.'
              : 'Failed to fetch stock data. Please check your API configuration.'
          }));
        } finally {
          setIsRefreshing(false);
          setLoadingProgress({ current: 0, total: WATCHLIST.length });
        }
      };

      useEffect(() => {
        fetchStockData(true); // Initial load

        // Smart refresh based on market hours
        const setupRefresh = () => {
          const interval = MarketHours.getRefreshInterval();
          return setInterval(() => {
            fetchStockData(false);
          }, interval);
        };

        let refreshInterval = setupRefresh();

        // Adjust refresh interval every 5 minutes based on market status
        const adjustInterval = setInterval(() => {
          clearInterval(refreshInterval);
          refreshInterval = setupRefresh();
          setMarketStatus(MarketHours.getStatusText());
        }, 300000); // Check every 5 minutes

        return () => {
          clearInterval(refreshInterval);
          clearInterval(adjustInterval);
        };
      }, []);

      const formatMarketCap = (cap) => {
        if (!cap) return 'N/A';
        if (cap >= 1e12) return `${(cap / 1e12).toFixed(2)}T`;
        if (cap >= 1e9) return `${(cap / 1e9).toFixed(2)}B`;
        if (cap >= 1e6) return `${(cap / 1e6).toFixed(2)}M`;
        return cap.toString();
      };

      // Only show full loading screen on initial load
      if (stockData.loading && stockData.allStocks.length === 0) {
        return (
          <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center">
            <div className="text-center">
              <div className="text-6xl mb-4 animate-pulse">üìä</div>
              <p className="text-xl">Loading live stock data...</p>
              <p className="text-sm text-gray-400 mt-2">
                Analyzing {WATCHLIST.length} stocks ‚Ä¢ Processing in batches
              </p>
              {loadingProgress.current > 0 && (
                <div className="mt-4">
                  <div className="bg-gray-700 rounded-full h-2 w-64 mx-auto">
                    <div 
                      className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                      style={{ width: `${(loadingProgress.current / loadingProgress.total) * 100}%` }}
                    ></div>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">
                    {loadingProgress.current} / {loadingProgress.total} stocks loaded
                  </p>
                </div>
              )}
              <p className="text-xs text-gray-500 mt-4">üîí Secure serverless API - All keys protected</p>
              <p className="text-xs text-gray-500 mt-1">‚è±Ô∏è Rate-limited batching to respect API limits</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-900 text-white p-4 md:p-6">
          {/* Info Modals */}
          <InfoModal isOpen={showRSIInfo} onClose={() => setShowRSIInfo(false)} title="üìä Understanding RSI">
            <RSIInfoContent />
          </InfoModal>

          <InfoModal isOpen={showScoreInfo} onClose={() => setShowScoreInfo(false)} title="üéØ Understanding Quantitative Scoring">
            <TechScoreInfoContent />
          </InfoModal>

          {/* Updating Banner */}
          {isRefreshing && (
            <div className="fixed top-0 left-0 right-0 bg-blue-600 text-white text-center py-2 z-50 animate-pulse">
              üîÑ Updating stock data... {loadingProgress.current > 0 && `(${loadingProgress.current}/${loadingProgress.total})`}
            </div>
          )}

          <div className={`mb-8 ${isRefreshing ? 'mt-12' : ''}`}>
            <div className="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
              <h1 className="text-2xl md:text-3xl font-bold">üìà Live Stock Tracker</h1>
              <div className="flex items-center gap-4 flex-wrap">
                <span className="text-sm px-3 py-1 bg-gray-800 rounded-lg">{marketStatus}</span>
                <button
                  onClick={() => fetchStockData(false)}
                  disabled={isRefreshing}
                  className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg disabled:opacity-50 transition-colors"
                >
                  {isRefreshing ? 'üîÑ' : '‚Üª'} Refresh
                </button>
                <div className="text-sm text-gray-400">
                  {refreshTime.toLocaleTimeString()}
                </div>
              </div>
            </div>

            {stockData.error && (
              <div className="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4">
                {stockData.error}
              </div>
            )}
            
            <div className="flex gap-2 md:gap-4 border-b border-gray-700 overflow-x-auto">
              <button
                onClick={() => setActiveTab('strong-buy')}
                className={`pb-2 px-3 md:px-4 font-medium whitespace-nowrap transition-colors ${
                  activeTab === 'strong-buy' 
                    ? 'text-green-400 border-b-2 border-green-400' 
                    : 'text-gray-400 hover:text-white'
                }`}
              >
                üìà Strong Buy ({stockData.strongBuys.length})
              </button>
              <button
                onClick={() => setActiveTab('significant-drops')}
                className={`pb-2 px-3 md:px-4 font-medium whitespace-nowrap transition-colors ${
                  activeTab === 'significant-drops' 
                    ? 'text-red-400 border-b-2 border-red-400' 
                    : 'text-gray-400 hover:text-white'
                }`}
              >
                üìâ Drops &gt;15% ({stockData.significantDrops.length})
              </button>
              <button
                onClick={() => setActiveTab('all-stocks')}
                className={`pb-2 px-3 md:px-4 font-medium whitespace-nowrap transition-colors ${
                  activeTab === 'all-stocks' 
                    ? 'text-blue-400 border-b-2 border-blue-400' 
                    : 'text-gray-400 hover:text-white'
                }`}
              >
                üìä All Stocks ({stockData.allStocks.length})
              </button>
            </div>
          </div>

          {/* Strong Buy Tab */}
          {activeTab === 'strong-buy' && (
            <div className="bg-gray-800 rounded-lg overflow-hidden">
              <div className="bg-green-600 px-4 md:px-6 py-3">
                <h2 className="text-lg font-semibold">üéØ Strong Buy Signals ({stockData.strongBuys.length} stocks)</h2>
              </div>
              
              {stockData.strongBuys.length === 0 ? (
                <div className="px-6 py-8 text-center text-gray-400">
                  No strong buy signals detected at this time. Market conditions may not be favorable.
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-700">
                      <tr>
                        <th className="px-3 py-3 text-left text-xs uppercase">Symbol</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Company</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Price</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">24H Change</th>
                        <th className="px-3 py-3 text-left text-xs uppercase hidden md:table-cell">Market Cap</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">RSI</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Quant Score</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Signal</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-600">
                      {stockData.strongBuys.map((s, i) => (
                        <tr key={i} className="hover:bg-gray-700 transition-colors">
                          <td className="px-3 py-4">
                            <a 
                              href={getGoogleFinanceUrl(s.symbol, s.exchange)} 
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="text-blue-400 font-semibold hover:text-blue-300 hover:underline"
                            >
                              {s.symbol}
                            </a>
                          </td>
                          <td className="px-3 py-4 max-w-[120px] truncate text-xs md:text-sm">{s.company}</td>
                          <td className="px-3 py-4 font-medium">${s.price.toFixed(2)}</td>
                          <td className={`px-3 py-4 font-medium ${s.change.startsWith('+') ? 'text-green-400' : 'text-red-400'}`}>
                            {s.change}
                          </td>
                          <td className="px-3 py-4 hidden md:table-cell">{s.marketCap}</td>
                          <td className={`px-3 py-4 font-medium ${
                            s.rsi === 'N/A' ? 'text-gray-400' : 
                            parseFloat(s.rsi) >= 70 ? 'text-red-400' :
                            parseFloat(s.rsi) <= 30 ? 'text-green-400' : 'text-blue-400'
                          }`}>
                            {s.rsi}
                          </td>
                          <td className={`px-3 py-4 font-bold ${
                            s.quantScore >= 80 ? 'text-green-400' :
                            s.quantScore >= 60 ? 'text-yellow-400' : 'text-gray-400'
                          }`}>
                            {s.quantScore}
                          </td>
                          <td className="px-3 py-4">
                            <div className="flex flex-col gap-1">
                              <span className={`bg-${s.signalColor} text-white px-2 py-1 rounded text-xs font-medium`}>
                                {s.prediction}
                              </span>
                              <span className="text-xs text-gray-400">{s.confidence}</span>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {/* Significant Drops Tab */}
          {activeTab === 'significant-drops' && (
            <div className="bg-gray-800 rounded-lg overflow-hidden">
              <div className="bg-red-600 px-4 md:px-6 py-3">
                <h2 className="text-lg font-semibold">‚ö†Ô∏è Significant Drops (&gt;15%)</h2>
              </div>
              
              {stockData.significantDrops.length === 0 ? (
                <div className="px-6 py-8 text-center text-gray-400">
                  No significant drops detected. All stocks within 15% of 3-month highs.
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-700">
                      <tr>
                        <th className="px-3 py-3 text-left text-xs uppercase">Symbol</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Company</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Price</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">24H Change</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Drop</th>
                        <th className="px-3 py-3 text-left text-xs uppercase hidden md:table-cell">3M High</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">RSI</th>
                        <th className="px-3 py-3 text-left text-xs uppercase">Signal</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-600">
                      {stockData.significantDrops.map((s, i) => (
                        <tr key={i} className="hover:bg-gray-700 transition-colors">
                          <td className="px-3 py-4">
                            <a 
                              href={getGoogleFinanceUrl(s.symbol, s.exchange)} 
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="text-blue-400 font-semibold hover:text-blue-300 hover:underline"
                            >
                              {s.symbol}
                            </a>
                          </td>
                          <td className="px-3 py-4 max-w-[120px] truncate text-xs md:text-sm">{s.company}</td>
                          <td className="px-3 py-4 font-medium">${s.price.toFixed(2)}</td>
                          <td className={`px-3 py-4 font-medium ${s.change.startsWith('+') ? 'text-green-400' : 'text-red-400'}`}>
                            {s.change}
                          </td>
                          <td className="px-3 py-4 font-medium text-red-400">{s.drop}</td>
                          <td className="px-3 py-4 hidden md:table-cell">${s.threeMonthHigh}</td>
                          <td className={`px-3 py-4 font-medium ${
                            s.rsi === 'N/A' ? 'text-gray-400' :
                            parseFloat(s.rsi) >= 70 ? 'text-red-400' :
                            parseFloat(s.rsi) <= 30 ? 'text-green-400' : 'text-blue-400'
                          }`}>
                            {s.rsi}
                          </td>
                          <td className="px-3 py-4">
                            <div className="flex flex-col gap-1">
                              <span className={`bg-${s.signalColor} text-white px-2 py-1 rounded text-xs font-medium`}>
                                {s.prediction}
                              </span>
                              <span className="text-xs text-gray-400">{s.confidence}</span>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {/* All Stocks Tab */}
          {activeTab === 'all-stocks' && (
            <div className="bg-gray-800 rounded-lg overflow-hidden">
              <div className="bg-blue-600 px-4 md:px-6 py-3">
                <h2 className="text-lg font-semibold">üìä All Tracked Stocks</h2>
              </div>
              
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-gray-700">
                    <tr>
                      <th className="px-3 py-3 text-left text-xs uppercase">Symbol</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">Company</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">Price</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">24H Change</th>
                      <th className="px-3 py-3 text-left text-xs uppercase hidden md:table-cell">3M High</th>
                      <th className="px-3 py-3 text-left text-xs uppercase hidden lg:table-cell">6M High</th>
                      <th className="px-3 py-3 text-left text-xs uppercase hidden md:table-cell">Market Cap</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">RSI</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">Quant Score</th>
                      <th className="px-3 py-3 text-left text-xs uppercase">Signal</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-600">
                    {stockData.allStocks.map((s, i) => (
                      <tr key={i} className="hover:bg-gray-700 transition-colors">
                        <td className="px-3 py-4">
                          <a 
                            href={getGoogleFinanceUrl(s.symbol, s.exchange)} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-blue-400 font-semibold hover:text-blue-300 hover:underline"
                          >
                            {s.symbol}
                          </a>
                        </td>
                        <td className="px-3 py-4 max-w-[120px] truncate text-xs md:text-sm">{s.company}</td>
                        <td className="px-3 py-4 font-medium">${s.price.toFixed(2)}</td>
                        <td className={`px-3 py-4 font-medium ${s.change.startsWith('+') ? 'text-green-400' : 'text-red-400'}`}>
                          {s.change}
                        </td>
                        <td className="px-3 py-4 hidden md:table-cell">${s.threeMonthHigh.toFixed(2)}</td>
                        <td className="px-3 py-4 hidden lg:table-cell">${s.sixMonthHigh.toFixed(2)}</td>
                        <td className="px-3 py-4 hidden md:table-cell">{s.marketCap}</td>
                        <td className={`px-3 py-4 font-medium ${
                          s.rsi === 'N/A' ? 'text-gray-400' :
                          parseFloat(s.rsi) >= 70 ? 'text-red-400' :
                          parseFloat(s.rsi) <= 30 ? 'text-green-400' : 'text-blue-400'
                        }`}>
                          {s.rsi}
                        </td>
                        <td className={`px-3 py-4 font-bold ${
                          s.quantScore >= 80 ? 'text-green-400' :
                          s.quantScore >= 60 ? 'text-yellow-400' : 'text-gray-400'
                        }`}>
                          {s.quantScore}
                        </td>
                        <td className="px-3 py-4">
                          <div className="flex flex-col gap-1">
                            <span className={`bg-${s.signalColor} text-white px-2 py-1 rounded text-xs font-medium`}>
                              {s.prediction}
                            </span>
                            <span className="text-xs text-gray-400">{s.confidence}</span>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Enhanced Footer with Info Buttons */}
          <div className="mt-8 space-y-3">
            <div className="text-center text-gray-400 text-xs">
              <p>
                üí∞ Live Data: Finnhub (quotes) + Tiingo (historical) ‚Ä¢ All via secure serverless API ‚Ä¢ Auto-refresh: {MarketHours.getRefreshIntervalText()}
              </p>
            </div>

            {/* RSI Explanation with Info Button */}
            <div className="flex items-center justify-center gap-2 text-xs">
              <div className="flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-lg">
                <span className="text-green-400">RSI &lt;30</span> = Oversold | 
                <span className="text-blue-400"> 30-70</span> = Neutral | 
                <span className="text-red-400"> &gt;70</span> = Overbought
                <button 
                  onClick={() => setShowRSIInfo(true)}
                  className="ml-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold transition-colors"
                  title="Learn more about RSI"
                >
                  ?
                </button>
              </div>
            </div>

            {/* Tech Score Explanation with Info Button */}
            <div className="flex items-center justify-center gap-2 text-xs">
              <div className="flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-lg">
                <span className="text-gray-300">Quant Score: Multi-Factor Model (Momentum + Mean Reversion + Trend + Risk-Adjusted + Value)</span>
                <button 
                  onClick={() => setShowScoreInfo(true)}
                  className="ml-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold transition-colors"
                  title="Learn more about Quantitative Scoring"
                >
                  ?
                </button>
              </div>
            </div>

            <div className="text-center text-xs space-y-1">
              <p className="text-green-400 font-medium">üîí Fully Secure - All API keys protected via serverless!</p>
              <p className="text-yellow-400 font-medium">‚ö° Batched Loading - Respects API rate limits (4 stocks/batch, 2s delay)</p>
              <p className="text-blue-400 font-medium">üí§ Smart Refresh - Prices frozen on weekends (6hr intervals save API calls)</p>
            </div>
          </div>
        </div>
      );
    };
    
    ReactDOM.render(<StockTracker />, document.getElementById('root'));
  </script>
</body>
</html>
